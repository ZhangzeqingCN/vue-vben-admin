<script lang="ts" setup>
  // mapboxgl地图
  import * as G from 'geojson';
  import * as L from 'leaflet';
  import 'leaflet/dist/leaflet.css';
  import { onMounted, reactive, ref } from 'vue';

  const mapZoom = ref(7);
  const mapCenter = ref<L.LatLng>(new L.LatLng(43.02071359427862, -107.34741210937501));

  const mapRef = ref<HTMLDivElement>();
  // const markers: L.Marker[] = [];

  const props = defineProps({
    debugPanel: {
      type: Boolean,
      default: false,
    },
  });

  const currentFocusedInfo = reactive({
    id: '',
    name: '',
    latlng: {
      x: 0,
      y: 0,
    },
  });

  // 每个Farm的附加属性
  type FarmGeoJsonProperties = {
    id?: string;
    name?: string;
    density?: number;
    // Fields集合数据
    fieldsGeoJsonData?: G.FeatureCollection<G.Geometry, FieldGeoJsonProperties>;
    // Fields的GeoJson对象
    fieldsGeoJson?: L.GeoJSON<FieldGeoJsonProperties, G.Geometry>;
  };

  // 每个Field的附加属性
  type FieldGeoJsonProperties = {
    id?: string;
    name?: string;
    // Devices集合数据
    devicesGeoJsonData?: G.FeatureCollection<G.Geometry, DeviceGeoJsonProperties>;
    // Devices的GeoJson对象
    devicesGeoJson?: L.GeoJSON<DeviceGeoJsonProperties, G.Geometry>;
  };

  type DeviceGeoJsonProperties = {
    id?: string;
    name?: string;
    type?: 'AP' | 'L' | 'TH' | 'CO2' | 'PH';
  };

  let farmsGeoJson: L.GeoJSON<FarmGeoJsonProperties, G.Geometry>;

  let map: L.Map;

  let prevFocusFarmProperties: FarmGeoJsonProperties;
  let prevFocusFieldProperties: FieldGeoJsonProperties;

  // https://geojson.io/
  const farmsGeoJsonData: G.FeatureCollection<G.Geometry, FarmGeoJsonProperties> = {
    type: 'FeatureCollection',
    features: [
      {
        type: 'Feature',
        id: '01',
        properties: { id: 'FARM#1252106', name: 'Alabama农业基地', density: 94.65 },
        geometry: {
          type: 'Polygon',
          coordinates: [
            [
              [-87.359296, 35.00118],
              [-85.606675, 34.984749],
              [-85.431413, 34.124869],
              [-85.184951, 32.859696],
              [-85.069935, 32.580372],
              [-84.960397, 32.421541],
              [-85.004212, 32.322956],
              [-84.889196, 32.262709],
              [-85.058981, 32.13674],
              [-85.053504, 32.01077],
              [-85.141136, 31.840985],
              [-85.042551, 31.539753],
              [-85.113751, 31.27686],
              [-85.004212, 31.003013],
              [-85.497137, 30.997536],
              [-87.600282, 30.997536],
              [-87.633143, 30.86609],
              [-87.408589, 30.674397],
              [-87.446927, 30.510088],
              [-87.37025, 30.427934],
              [-87.518128, 30.280057],
              [-87.655051, 30.247195],
              [-87.90699, 30.411504],
              [-87.934375, 30.657966],
              [-88.011052, 30.685351],
              [-88.10416, 30.499135],
              [-88.137022, 30.318396],
              [-88.394438, 30.367688],
              [-88.471115, 31.895754],
              [-88.241084, 33.796253],
              [-88.098683, 34.891641],
              [-88.202745, 34.995703],
              [-87.359296, 35.00118],
            ],
          ],
        },
      },
      {
        type: 'Feature',
        id: '04',
        properties: { id: 'FARM#7427323', name: 'Arizona农业基地', density: 57.05 },
        geometry: {
          type: 'Polygon',
          coordinates: [
            [
              [-109.042503, 37.000263],
              [-109.04798, 31.331629],
              [-111.074448, 31.331629],
              [-112.246513, 31.704061],
              [-114.815198, 32.492741],
              [-114.72209, 32.717295],
              [-114.524921, 32.755634],
              [-114.470151, 32.843265],
              [-114.524921, 33.029481],
              [-114.661844, 33.034958],
              [-114.727567, 33.40739],
              [-114.524921, 33.54979],
              [-114.497536, 33.697668],
              [-114.535874, 33.933176],
              [-114.415382, 34.108438],
              [-114.256551, 34.174162],
              [-114.136058, 34.305608],
              [-114.333228, 34.448009],
              [-114.470151, 34.710902],
              [-114.634459, 34.87521],
              [-114.634459, 35.00118],
              [-114.574213, 35.138103],
              [-114.596121, 35.324319],
              [-114.678275, 35.516012],
              [-114.738521, 36.102045],
              [-114.371566, 36.140383],
              [-114.251074, 36.01989],
              [-114.152489, 36.025367],
              [-114.048427, 36.195153],
              [-114.048427, 37.000263],
              [-110.499369, 37.00574],
              [-109.042503, 37.000263],
            ],
          ],
        },
      },
      {
        type: 'Feature',
        id: '05',
        properties: { id: 'FARM#2075342', name: 'Arkansas农业基地', density: 56.43 },
        geometry: {
          type: 'Polygon',
          coordinates: [
            [
              [-94.473842, 36.501861],
              [-90.152536, 36.496384],
              [-90.064905, 36.304691],
              [-90.218259, 36.184199],
              [-90.377091, 35.997983],
              [-89.730812, 35.997983],
              [-89.763673, 35.811767],
              [-89.911551, 35.756997],
              [-89.944412, 35.603643],
              [-90.130628, 35.439335],
              [-90.114197, 35.198349],
              [-90.212782, 35.023087],
              [-90.311367, 34.995703],
              [-90.251121, 34.908072],
              [-90.409952, 34.831394],
              [-90.481152, 34.661609],
              [-90.585214, 34.617794],
              [-90.568783, 34.420624],
              [-90.749522, 34.365854],
              [-90.744046, 34.300131],
              [-90.952169, 34.135823],
              [-90.891923, 34.026284],
              [-91.072662, 33.867453],
              [-91.231493, 33.560744],
              [-91.056231, 33.429298],
              [-91.143862, 33.347144],
              [-91.089093, 33.13902],
              [-91.16577, 33.002096],
              [-93.608485, 33.018527],
              [-94.041164, 33.018527],
              [-94.041164, 33.54979],
              [-94.183564, 33.593606],
              [-94.380734, 33.544313],
              [-94.484796, 33.637421],
              [-94.430026, 35.395519],
              [-94.616242, 36.501861],
              [-94.473842, 36.501861],
            ],
          ],
        },
      },
      {
        type: 'Feature',
        id: '16',
        properties: { id: 'FARM#8791254', name: 'Idaho农业基地', density: 19.15 },
        geometry: {
          type: 'Polygon',
          coordinates: [
            [
              [-116.04751, 49.000239],
              [-116.04751, 47.976051],
              [-115.724371, 47.696727],
              [-115.718894, 47.42288],
              [-115.527201, 47.302388],
              [-115.324554, 47.258572],
              [-115.302646, 47.187372],
              [-114.930214, 46.919002],
              [-114.886399, 46.809463],
              [-114.623506, 46.705401],
              [-114.612552, 46.639678],
              [-114.322274, 46.645155],
              [-114.464674, 46.272723],
              [-114.492059, 46.037214],
              [-114.387997, 45.88386],
              [-114.568736, 45.774321],
              [-114.497536, 45.670259],
              [-114.546828, 45.560721],
              [-114.333228, 45.456659],
              [-114.086765, 45.593582],
              [-113.98818, 45.703121],
              [-113.807441, 45.604536],
              [-113.834826, 45.522382],
              [-113.736241, 45.330689],
              [-113.571933, 45.128042],
              [-113.45144, 45.056842],
              [-113.456917, 44.865149],
              [-113.341901, 44.782995],
              [-113.133778, 44.772041],
              [-113.002331, 44.448902],
              [-112.887315, 44.394132],
              [-112.783254, 44.48724],
              [-112.471068, 44.481763],
              [-112.241036, 44.569394],
              [-112.104113, 44.520102],
              [-111.868605, 44.563917],
              [-111.819312, 44.509148],
              [-111.616665, 44.547487],
              [-111.386634, 44.75561],
              [-111.227803, 44.580348],
              [-111.047063, 44.476286],
              [-111.047063, 42.000709],
              [-112.164359, 41.995232],
              [-114.04295, 41.995232],
              [-117.027882, 42.000709],
              [-117.027882, 43.830007],
              [-116.896436, 44.158624],
              [-116.97859, 44.240778],
              [-117.170283, 44.257209],
              [-117.241483, 44.394132],
              [-117.038836, 44.750133],
              [-116.934774, 44.782995],
              [-116.830713, 44.930872],
              [-116.847143, 45.02398],
              [-116.732128, 45.144473],
              [-116.671881, 45.319735],
              [-116.463758, 45.61549],
              [-116.545912, 45.752413],
              [-116.78142, 45.823614],
              [-116.918344, 45.993399],
              [-116.92382, 46.168661],
              [-117.055267, 46.343923],
              [-117.038836, 46.426077],
              [-117.044313, 47.762451],
              [-117.033359, 49.000239],
              [-116.04751, 49.000239],
            ],
          ],
        },
      },
      {
        type: 'Feature',
        id: '17',
        properties: { id: 'FARM#2445316', name: 'Illinois农业基地', density: 231.5 },
        geometry: {
          type: 'Polygon',
          coordinates: [
            [
              [-90.639984, 42.510065],
              [-88.788778, 42.493634],
              [-87.802929, 42.493634],
              [-87.83579, 42.301941],
              [-87.682436, 42.077386],
              [-87.523605, 41.710431],
              [-87.529082, 39.34987],
              [-87.63862, 39.169131],
              [-87.512651, 38.95553],
              [-87.49622, 38.780268],
              [-87.62219, 38.637868],
              [-87.655051, 38.506421],
              [-87.83579, 38.292821],
              [-87.950806, 38.27639],
              [-87.923421, 38.15042],
              [-88.000098, 38.101128],
              [-88.060345, 37.865619],
              [-88.027483, 37.799896],
              [-88.15893, 37.657496],
              [-88.065822, 37.482234],
              [-88.476592, 37.389126],
              [-88.514931, 37.285064],
              [-88.421823, 37.153617],
              [-88.547792, 37.071463],
              [-88.914747, 37.224817],
              [-89.029763, 37.213863],
              [-89.183118, 37.038601],
              [-89.133825, 36.983832],
              [-89.292656, 36.994786],
              [-89.517211, 37.279587],
              [-89.435057, 37.34531],
              [-89.517211, 37.537003],
              [-89.517211, 37.690357],
              [-89.84035, 37.903958],
              [-89.949889, 37.88205],
              [-90.059428, 38.013497],
              [-90.355183, 38.216144],
              [-90.349706, 38.374975],
              [-90.179921, 38.632391],
              [-90.207305, 38.725499],
              [-90.10872, 38.845992],
              [-90.251121, 38.917192],
              [-90.470199, 38.961007],
              [-90.585214, 38.867899],
              [-90.661891, 38.928146],
              [-90.727615, 39.256762],
              [-91.061708, 39.470363],
              [-91.368417, 39.727779],
              [-91.494386, 40.034488],
              [-91.50534, 40.237135],
              [-91.417709, 40.379535],
              [-91.401278, 40.560274],
              [-91.121954, 40.669813],
              [-91.09457, 40.823167],
              [-90.963123, 40.921752],
              [-90.946692, 41.097014],
              [-91.111001, 41.239415],
              [-91.045277, 41.414677],
              [-90.656414, 41.463969],
              [-90.344229, 41.589939],
              [-90.311367, 41.743293],
              [-90.179921, 41.809016],
              [-90.141582, 42.000709],
              [-90.168967, 42.126679],
              [-90.393521, 42.225264],
              [-90.420906, 42.329326],
              [-90.639984, 42.510065],
            ],
          ],
        },
      },
      {
        type: 'Feature',
        id: '18',
        properties: { id: 'FARM#1478433', name: 'Indiana农业基地', density: 181.7 },
        geometry: {
          type: 'Polygon',
          coordinates: [
            [
              [-85.990061, 41.759724],
              [-84.807042, 41.759724],
              [-84.807042, 41.694001],
              [-84.801565, 40.500028],
              [-84.817996, 39.103408],
              [-84.894673, 39.059592],
              [-84.812519, 38.785745],
              [-84.987781, 38.780268],
              [-85.173997, 38.68716],
              [-85.431413, 38.730976],
              [-85.42046, 38.533806],
              [-85.590245, 38.451652],
              [-85.655968, 38.325682],
              [-85.83123, 38.27639],
              [-85.924338, 38.024451],
              [-86.039354, 37.958727],
              [-86.263908, 38.051835],
              [-86.302247, 38.166851],
              [-86.521325, 38.040881],
              [-86.504894, 37.931343],
              [-86.729448, 37.893004],
              [-86.795172, 37.991589],
              [-87.047111, 37.893004],
              [-87.129265, 37.788942],
              [-87.381204, 37.93682],
              [-87.512651, 37.903958],
              [-87.600282, 37.975158],
              [-87.682436, 37.903958],
              [-87.934375, 37.893004],
              [-88.027483, 37.799896],
              [-88.060345, 37.865619],
              [-88.000098, 38.101128],
              [-87.923421, 38.15042],
              [-87.950806, 38.27639],
              [-87.83579, 38.292821],
              [-87.655051, 38.506421],
              [-87.62219, 38.637868],
              [-87.49622, 38.780268],
              [-87.512651, 38.95553],
              [-87.63862, 39.169131],
              [-87.529082, 39.34987],
              [-87.523605, 41.710431],
              [-87.42502, 41.644708],
              [-87.118311, 41.644708],
              [-86.822556, 41.759724],
              [-85.990061, 41.759724],
            ],
          ],
        },
      },
      {
        type: 'Feature',
        id: '19',
        properties: { id: 'FARM#4352643', name: 'Iowa农业基地', density: 54.81 },
        geometry: {
          type: 'Polygon',
          coordinates: [
            [
              [-91.368417, 43.501391],
              [-91.215062, 43.501391],
              [-91.204109, 43.353514],
              [-91.056231, 43.254929],
              [-91.176724, 43.134436],
              [-91.143862, 42.909881],
              [-91.067185, 42.75105],
              [-90.711184, 42.636034],
              [-90.639984, 42.510065],
              [-90.420906, 42.329326],
              [-90.393521, 42.225264],
              [-90.168967, 42.126679],
              [-90.141582, 42.000709],
              [-90.179921, 41.809016],
              [-90.311367, 41.743293],
              [-90.344229, 41.589939],
              [-90.656414, 41.463969],
              [-91.045277, 41.414677],
              [-91.111001, 41.239415],
              [-90.946692, 41.097014],
              [-90.963123, 40.921752],
              [-91.09457, 40.823167],
              [-91.121954, 40.669813],
              [-91.401278, 40.560274],
              [-91.417709, 40.379535],
              [-91.527248, 40.412397],
              [-91.729895, 40.615043],
              [-91.833957, 40.609566],
              [-93.257961, 40.582182],
              [-94.632673, 40.571228],
              [-95.7664, 40.587659],
              [-95.881416, 40.719105],
              [-95.826646, 40.976521],
              [-95.925231, 41.201076],
              [-95.919754, 41.453015],
              [-96.095016, 41.540646],
              [-96.122401, 41.67757],
              [-96.062155, 41.798063],
              [-96.127878, 41.973325],
              [-96.264801, 42.039048],
              [-96.44554, 42.488157],
              [-96.631756, 42.707235],
              [-96.544125, 42.855112],
              [-96.511264, 43.052282],
              [-96.434587, 43.123482],
              [-96.560556, 43.222067],
              [-96.527695, 43.397329],
              [-96.582464, 43.479483],
              [-96.451017, 43.501391],
              [-91.368417, 43.501391],
            ],
          ],
        },
      },
      {
        type: 'Feature',
        id: '27',
        properties: { id: 'FARM#2325211', name: 'Minnesota农业基地', density: 67.14 },
        geometry: {
          type: 'Polygon',
          coordinates: [
            [
              [-92.014696, 46.705401],
              [-92.091373, 46.749217],
              [-92.29402, 46.667063],
              [-92.29402, 46.075553],
              [-92.354266, 46.015307],
              [-92.639067, 45.933153],
              [-92.869098, 45.719552],
              [-92.885529, 45.577151],
              [-92.770513, 45.566198],
              [-92.644544, 45.440228],
              [-92.75956, 45.286874],
              [-92.737652, 45.117088],
              [-92.808852, 44.750133],
              [-92.545959, 44.569394],
              [-92.337835, 44.552964],
              [-92.233773, 44.443425],
              [-91.927065, 44.333886],
              [-91.877772, 44.202439],
              [-91.592971, 44.032654],
              [-91.43414, 43.994316],
              [-91.242447, 43.775238],
              [-91.269832, 43.616407],
              [-91.215062, 43.501391],
              [-91.368417, 43.501391],
              [-96.451017, 43.501391],
              [-96.451017, 45.297827],
              [-96.681049, 45.412843],
              [-96.856311, 45.604536],
              [-96.582464, 45.818137],
              [-96.560556, 45.933153],
              [-96.598895, 46.332969],
              [-96.719387, 46.437031],
              [-96.801542, 46.656109],
              [-96.785111, 46.924479],
              [-96.823449, 46.968294],
              [-96.856311, 47.609096],
              [-97.053481, 47.948667],
              [-97.130158, 48.140359],
              [-97.16302, 48.545653],
              [-97.097296, 48.682577],
              [-97.228743, 49.000239],
              [-95.152983, 49.000239],
              [-95.152983, 49.383625],
              [-94.955813, 49.372671],
              [-94.824366, 49.295994],
              [-94.69292, 48.775685],
              [-94.588858, 48.715438],
              [-94.260241, 48.699007],
              [-94.221903, 48.649715],
              [-93.838517, 48.627807],
              [-93.794701, 48.518268],
              [-93.466085, 48.545653],
              [-93.466085, 48.589469],
              [-93.208669, 48.644238],
              [-92.984114, 48.62233],
              [-92.726698, 48.540176],
              [-92.655498, 48.436114],
              [-92.50762, 48.447068],
              [-92.370697, 48.222514],
              [-92.304974, 48.315622],
              [-92.053034, 48.359437],
              [-92.009219, 48.266329],
              [-91.713464, 48.200606],
              [-91.713464, 48.112975],
              [-91.565587, 48.041775],
              [-91.264355, 48.080113],
              [-91.083616, 48.178698],
              [-90.837154, 48.238944],
              [-90.749522, 48.091067],
              [-90.579737, 48.123929],
              [-90.377091, 48.091067],
              [-90.141582, 48.112975],
              [-89.873212, 47.987005],
              [-89.615796, 48.008913],
              [-89.637704, 47.954144],
              [-89.971797, 47.828174],
              [-90.437337, 47.729589],
              [-90.738569, 47.625527],
              [-91.171247, 47.368111],
              [-91.357463, 47.20928],
              [-91.642264, 47.028541],
              [-92.091373, 46.787555],
              [-92.014696, 46.705401],
            ],
          ],
        },
      },
      {
        type: 'Feature',
        id: '31',
        properties: {
          id: 'FARM#1443233',
          name: 'Nebraska农业基地',
          density: 23.97,
          fieldsGeoJsonData: {
            type: 'FeatureCollection',
            features: [
              {
                type: 'Feature',
                properties: {
                  id: 'FILED#241254',
                  name: '测试农田1',
                },
                geometry: {
                  coordinates: [
                    [
                      [-103.11048950802447, 42.6617267505799],
                      [-103.11048950802447, 41.48394579809309],
                      [-100.88855382341745, 41.48394579809309],
                      [-100.88855382341745, 42.6617267505799],
                      [-103.11048950802447, 42.6617267505799],
                    ],
                  ],
                  type: 'Polygon',
                },
              },
              {
                type: 'Feature',
                properties: {
                  id: 'FILED#241254',
                  name: '测试农田1',
                },
                geometry: {
                  coordinates: [
                    [
                      [-100.57639271564665, 42.61652207123569],
                      [-100.57639271564665, 40.30508061527985],
                      [-97.3040756037224, 40.30508061527985],
                      [-97.3040756037224, 42.61652207123569],
                      [-100.57639271564665, 42.61652207123569],
                    ],
                  ],
                  type: 'Polygon',
                },
              },
              {
                type: 'Feature',
                properties: {},
                geometry: {
                  coordinates: [
                    [
                      [-96.98826531454785, 41.34125537331042],
                      [-96.97270823443455, 40.47999551193368],
                      [-95.99261150559846, 40.46938281076942],
                      [-96.1510430454492, 41.351485537054],
                      [-96.98826531454785, 41.34125537331042],
                    ],
                  ],
                  type: 'Polygon',
                },
              },
            ],
          },
        },
        geometry: {
          type: 'Polygon',
          coordinates: [
            [
              [-103.324578, 43.002989],
              [-101.626726, 42.997512],
              [-98.499393, 42.997512],
              [-98.466531, 42.94822],
              [-97.951699, 42.767481],
              [-97.831206, 42.866066],
              [-97.688806, 42.844158],
              [-97.217789, 42.844158],
              [-96.692003, 42.657942],
              [-96.626279, 42.515542],
              [-96.44554, 42.488157],
              [-96.264801, 42.039048],
              [-96.127878, 41.973325],
              [-96.062155, 41.798063],
              [-96.122401, 41.67757],
              [-96.095016, 41.540646],
              [-95.919754, 41.453015],
              [-95.925231, 41.201076],
              [-95.826646, 40.976521],
              [-95.881416, 40.719105],
              [-95.7664, 40.587659],
              [-95.552799, 40.264519],
              [-95.306337, 40.001626],
              [-101.90605, 40.001626],
              [-102.053927, 40.001626],
              [-102.053927, 41.003906],
              [-104.053011, 41.003906],
              [-104.053011, 43.002989],
              [-103.324578, 43.002989],
            ],
          ],
        },
      },
      {
        type: 'Feature',
        id: '49',
        properties: { id: 'FARM#1424243', name: 'Utah农业基地', density: 34.3 },
        geometry: {
          type: 'Polygon',
          coordinates: [
            [
              [-112.164359, 41.995232],
              [-111.047063, 42.000709],
              [-111.047063, 40.998429],
              [-109.04798, 40.998429],
              [-109.053457, 39.125316],
              [-109.058934, 38.27639],
              [-109.042503, 38.166851],
              [-109.042503, 37.000263],
              [-110.499369, 37.00574],
              [-114.048427, 37.000263],
              [-114.04295, 41.995232],
              [-112.164359, 41.995232],
            ],
          ],
        },
      },
      {
        type: 'Feature',
        id: '56',
        properties: {
          id: 'FARM#4231425',
          name: 'Wyoming农业基地',
          density: 5.851,
          fieldsGeoJsonData: {
            type: 'FeatureCollection',
            features: [
              {
                type: 'Feature',
                properties: {
                  id: 'FILED#241254',
                  name: '测试农田1',
                  devicesGeoJsonData: {
                    type: 'FeatureCollection',
                    features: [
                      {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                          coordinates: [-107.9916929678275, 42.654421107865886],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                          coordinates: [-106.62512977786477, 42.71799896325621],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                          coordinates: [-106.33105921799935, 42.37390575840669],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                          coordinates: [-106.46079622970448, 42.015066174511134],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                          coordinates: [-107.0662356176629, 42.09213186871858],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                          coordinates: [-108.05223690662346, 42.09213186871858],
                          type: 'Point',
                        },
                      },
                    ],
                  },
                },
                geometry: {
                  coordinates: [
                    [
                      [-108.47811833593188, 42.88331486188966],
                      [-108.54499106320031, 41.60033412232602],
                      [-105.77534560883826, 41.508589436648776],
                      [-105.76420015429362, 42.87106354674208],
                      [-108.47811833593188, 42.88331486188966],
                    ],
                  ],
                  type: 'Polygon',
                },
              },
              {
                type: 'Feature',
                properties: {
                  id: 'FILED#241254',
                  name: '测试农田1',
                  devicesGeoJsonData: {
                    type: 'FeatureCollection',
                    features: [
                      {
                        type: 'Feature',
                        properties: {
                          type: 'AP',
                          id: 'AP#9014932',
                        },
                        geometry: {
                          coordinates: [-106.22851783967842, 43.50545297593516],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'PH',
                          id: 'PH#7051245',
                        },
                        geometry: {
                          coordinates: [-105.56847809263827, 43.44783360354003],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'CO2',
                          id: 'CO2#557190',
                        },
                        geometry: {
                          coordinates: [-104.52631007099681, 43.46224359746998],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'AP',
                          id: 'AP#4241221',
                        },
                        geometry: {
                          coordinates: [-104.5163846612668, 42.98127084559687],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'L',
                          id: 'L#42578543',
                        },
                        geometry: {
                          coordinates: [-104.57097441478128, 42.569644898471694],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'AP',
                          id: 'AP#0826842',
                        },
                        geometry: {
                          coordinates: [-104.61067605370091, 42.05218882301065],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'CO2',
                          id: 'CO2#654932',
                        },
                        geometry: {
                          coordinates: [-105.42455965155446, 42.08902795517483],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'L',
                          id: 'L#78543900',
                        },
                        geometry: {
                          coordinates: [-105.508925634259, 42.45990418899413],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'TH',
                          id: 'LH#0878932',
                        },
                        geometry: {
                          coordinates: [-105.43944776614929, 42.85770658356773],
                          type: 'Point',
                        },
                        id: 8,
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'AP',
                          id: 'AP#7643954',
                        },
                        geometry: {
                          coordinates: [-106.07963669372938, 43.111833460710955],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'AP',
                          id: 'AP#5367765',
                        },
                        geometry: {
                          coordinates: [-106.47169037806113, 43.22403966910451],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'PH',
                          id: 'PH#7546541',
                        },
                        geometry: {
                          coordinates: [-105.71735923858728, 43.267418989427284],
                          type: 'Point',
                        },
                        id: 11,
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'CO2',
                          id: 'CO2#213478',
                        },
                        geometry: {
                          coordinates: [-104.83896047748925, 43.19872080042927],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'L',
                          id: 'L#75849307',
                        },
                        geometry: {
                          coordinates: [-105.11190924506204, 42.613487219841886],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'AP',
                          id: 'AP#0246456',
                        },
                        geometry: {
                          coordinates: [-104.92332646019337, 42.360972814682924],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'L',
                          id: 'L#76532329',
                        },
                        geometry: {
                          coordinates: [-104.81414695316441, 42.88316654069234],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'PH',
                          id: 'PH#4664546',
                        },
                        geometry: {
                          coordinates: [-105.32034284939031, 43.24211814001046],
                          type: 'Point',
                        },
                        id: 16,
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'AP',
                          id: 'AP#7546283',
                        },
                        geometry: {
                          coordinates: [-104.92332646019337, 42.10007552555746],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'CO2',
                          id: 'CO2#216898',
                        },
                        geometry: {
                          coordinates: [-105.24093957155101, 42.37563916034267],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'L',
                          id: 'L#158597965',
                        },
                        geometry: {
                          coordinates: [-105.72728464831731, 43.07559394340248],
                          type: 'Point',
                        },
                        id: 19,
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'PH',
                          id: 'PH#7549632',
                        },
                        geometry: {
                          coordinates: [-106.03497234994495, 43.393765545393364],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'CO2',
                          id: 'CO2#437456',
                        },
                        geometry: {
                          coordinates: [-106.5858325899553, 43.541437181990375],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'L',
                          id: 'L#329654175',
                        },
                        geometry: {
                          coordinates: [-106.57590718022571, 43.03207821685504],
                          type: 'Point',
                        },
                      },
                      {
                        type: 'Feature',
                        properties: {
                          type: 'CO2',
                          id: 'CO2#436347',
                        },
                        geometry: {
                          coordinates: [-106.35258546130217, 43.05383993983108],
                          type: 'Point',
                        },
                      },
                    ],
                  },
                },
                geometry: {
                  coordinates: [
                    [
                      [-106.76778086589955, 42.947638403103554],
                      [-105.67106626304853, 42.950667647409375],
                      [-105.67934335439075, 41.92137992219557],
                      [-104.30948473724469, 41.89982093103532],
                      [-104.29293055456023, 43.667385387945274],
                      [-106.78433504858403, 43.70928199079256],
                      [-106.76778086589955, 42.947638403103554],
                    ],
                  ],
                  type: 'Polygon',
                },
              },
            ],
          },
        },
        geometry: {
          type: 'Polygon',
          coordinates: [
            [
              [-109.080842, 45.002073],
              [-105.91517, 45.002073],
              [-104.058488, 44.996596],
              [-104.053011, 43.002989],
              [-104.053011, 41.003906],
              [-105.728954, 40.998429],
              [-107.919731, 41.003906],
              [-109.04798, 40.998429],
              [-111.047063, 40.998429],
              [-111.047063, 42.000709],
              [-111.047063, 44.476286],
              [-111.05254, 45.002073],
              [-109.080842, 45.002073],
            ],
          ],
        },
      },
    ],
  };

  function valueOrDefault<T>(value: T | undefined | null, defaultValue: T) {
    return value ? value : defaultValue;
  }

  function updateMapData() {
    mapZoom.value = map.getZoom();
    mapCenter.value = map.getCenter();
  }

  onMounted(function () {
    initMap();
  });

  function initMap() {
    const mapDiv = mapRef.value!;

    map = L.map(mapDiv).setView(mapCenter.value, mapZoom.value);

    const popup: L.Popup = L.popup();

    map.on('click', function (e: L.LeafletMouseEvent) {
      updateMapData();
      popup.setLatLng(e.latlng).setContent(e.latlng.toString());
    });

    map.on('zoom', function () {
      updateMapData();
    });

    map.on('drag', function () {
      updateMapData();
    });

    // 网络地图图层
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 初始化 FARM GJ
    farmsGeoJson = L.geoJSON(farmsGeoJsonData, {
      style: {
        fillColor: 'yellow', // 填充颜色
        fillOpacity: 0.5, // 填充透明度
        color: 'red', // 边框颜色
        weight: 2, // 边框宽度
      },
      onEachFeature: function (
        farmFeature: G.Feature<G.Geometry, FarmGeoJsonProperties>,
        layer: L.Layer,
      ) {
        // 添加事件响应
        layer.on({
          mouseover: function (e: L.LeafletMouseEvent) {
            const layer = e.target;
            layer.setStyle({
              weight: 5,
              color: '#666',
              dashArray: '',
              fillOpacity: 0.7,
            });
          },
          mouseout: function (e: L.LeafletMouseEvent) {
            farmsGeoJson.resetStyle(e.target);
          },
          click: function (e: L.LeafletMouseEvent) {
            map.fitBounds(e.target.getBounds());
            setTimeout(function () {
              // Popup Farm信息
              const currFocusFarmProperties: FarmGeoJsonProperties = farmFeature.properties;
              const { name, id } = currFocusFarmProperties;
              currentFocusedInfo.id = id ? id : 'None ID';
              currentFocusedInfo.name = name ? name : 'None Name';
              currentFocusedInfo.latlng.x = mapCenter.value.lat;
              currentFocusedInfo.latlng.y = mapCenter.value.lng;
              const latlng: L.LatLng = e.latlng;
              popup
                .setContent(`<h1>${name}</h1><br>${id}<br>${latlng.toString()}<br>`)
                .setLatLng(map.getCenter())
                .openOn(map);
              // 隐藏前一个Field的Devices
              prevFocusFieldProperties?.devicesGeoJson?.remove();
              // 隐藏前一个Farm的Fields
              prevFocusFarmProperties?.fieldsGeoJson?.remove();
              // 展示当前Farm的Fields
              currFocusFarmProperties?.fieldsGeoJson?.addTo(map);
              prevFocusFieldProperties?.devicesGeoJson?.remove();
              prevFocusFarmProperties = currFocusFarmProperties;
            }, 200);
          },
        });

        // Field
        const farmProperties = farmFeature.properties;
        const fieldsGeoJsonData = farmProperties.fieldsGeoJsonData;
        if (fieldsGeoJsonData) {
          // 存在农田信息
          farmProperties.fieldsGeoJson = L.geoJSON(fieldsGeoJsonData, {
            style: {
              fillColor: 'green',
              fillOpacity: 0.5,
              color: 'blue',
              weight: 2,
            },
            onEachFeature(
              fieldFeature: G.Feature<G.Geometry, FieldGeoJsonProperties>,
              layer: L.Layer,
            ) {
              // 绑定农田的事件响应
              layer.on({
                mouseover(e: L.LeafletMouseEvent) {
                  const layer = e.target;
                  layer.setStyle({
                    weight: 5,
                    color: '#943',
                    dashArray: '',
                    fillOpacity: 0.7,
                    fillColor: 'white',
                  });
                },
                mouseout(e: L.LeafletMouseEvent) {
                  const layer = e.target;
                  layer.setStyle({
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    color: 'blue',
                    weight: 2,
                  });
                },
                click(e: L.LeafletMouseEvent) {
                  map.fitBounds(e.target.getBounds());
                  setTimeout(function () {
                    // Popup Farm信息
                    const currFocusFieldProperties: FieldGeoJsonProperties =
                      fieldFeature.properties;
                    const { name, id } = currFocusFieldProperties;
                    currentFocusedInfo.id = id ? id : 'None ID';
                    currentFocusedInfo.name = name ? name : 'None Name';
                    currentFocusedInfo.latlng.x = mapCenter.value.lat;
                    currentFocusedInfo.latlng.y = mapCenter.value.lng;
                    const latlng: L.LatLng = e.latlng;
                    popup
                      .setContent(`<h1>${name}</h1><br>${id}<br>${latlng.toString()}<br>`)
                      .setLatLng(map.getCenter())
                      .openOn(map);

                    // 隐藏前一个Field的Devices
                    prevFocusFieldProperties?.devicesGeoJson?.remove();
                    // 展示当前Field的Devices
                    currFocusFieldProperties?.devicesGeoJson?.addTo(map);

                    prevFocusFieldProperties = currFocusFieldProperties;
                  }, 200);
                },
              });

              // 初始化设备
              const fieldProperties = fieldFeature.properties;
              const devicesGeoJsonData = fieldProperties.devicesGeoJsonData;
              if (devicesGeoJsonData) {
                // 存在设备信息
                // 教程 https://leafletjs.com/examples/geojson/
                fieldProperties.devicesGeoJson = L.geoJSON(devicesGeoJsonData, {
                  pointToLayer(
                    deviceFeature: G.Feature<G.Geometry, DeviceGeoJsonProperties>,
                    latlng: L.LatLng,
                  ) {
                    return L.marker(latlng, {});
                  },
                  onEachFeature(
                    deviceFeature: G.Feature<G.Geometry, DeviceGeoJsonProperties>,
                    layer: L.Layer,
                  ) {
                    layer.on({
                      click(e: L.LeafletMouseEvent) {
                        const properties = deviceFeature.properties;
                        popup
                          .setContent(
                            `ID: ${valueOrDefault(properties.id, 'No ID')}<br>Name: ${valueOrDefault(properties.name, 'No Name')}<br>Type: ${valueOrDefault(properties.type, 'No Type')}`,
                          )
                          .setLatLng(e.latlng)
                          .openOn(map);
                      },
                    });
                  },
                });
              }
            },
          });
        }
      },
    }).addTo(map);
  }
</script>

<template>
  <h1>TestMap</h1>
  <div v-if="props.debugPanel">
    <el-descriptions title="Device Info">
      <el-descriptions-item label="Name">{{ currentFocusedInfo.name }}</el-descriptions-item>
      <el-descriptions-item label="ID">{{ currentFocusedInfo.id }}</el-descriptions-item>
      <el-descriptions-item label="LatLng">
        ({{ currentFocusedInfo.latlng.x.toFixed(2) }},{{ currentFocusedInfo.latlng.y.toFixed(2) }})
      </el-descriptions-item>
    </el-descriptions>
    <div>{{ mapZoom }}</div>
    <div>
      <el-button-group>
        <el-button @click="farmsGeoJson.remove()">隐藏全部农业基地</el-button>
        <el-button @click="farmsGeoJson.addTo(map)">显示全部农业基地</el-button>
      </el-button-group>
    </div>
    <div>当前位置 ({{ mapCenter.lat.toFixed(2) }},{{ mapCenter.lng.toFixed(2) }})</div>
    <div>当前位置 ({{ mapCenter.lat }},{{ mapCenter.lng }})</div>
  </div>
  <div id="map" ref="mapRef"></div>
</template>

<style scoped>
  #map {
    width: 100%;
    height: 100%;
  }
</style>
